!function(){function Mapv(a){this._initOptions(a),this._initDrawScale(),this._initDataRange(),this._initGeodata(),this._initLayer(),this._initDrawTypeControl(),this._initOptionDataControl(),this.setOptions(a),new DataControl(this)}function Layer(a,b,c){this.ctx=null,this.drawCbk=c,this.map=a,this.mapv=b;var d=new MapMask({map:a,elementTag:"canvas"});this.ctx=d.getContainer().getContext("2d");var e=this;d.addEventListener("draw",function(){e.draw()})}function MapMask(a){this.options=a||{},this.initElement(),this._map=a.map,this.show()}function GeoData(a){var b=a.options.map,c=a.options.data;this["super"]=a,this.setData(c),this.map=b}function DataControl(a){this.initDom(),this.initEvent(),this.initHistory(),this["super"]=a,this.geoData=a.geoData}function DataRangeControl(){this.defaultAnchor=BMAP_ANCHOR_BOTTOM_RIGHT,this.defaultOffset=new BMap.Size(10,10)}function DrawScale(){this.init(),this._Event()}function drawTips(a){var b=a.left,c=a.right,d=a.top,e=a.ctx;e.beginPath(),e.moveTo(b+8,d-7),e.lineTo(c,d-7),e.lineTo(c,d+7),e.lineTo(b+8,d+7),e.lineTo(b,d),e.fill();var f=e.isPointInPath(a.sup.point.x,a.sup.point.y);f&&(a.sup.hoveredHandle=a),e.save(),e.fillStyle="white",e.fillText(a.text,b+8,d),e.restore()}function DrawTypeControl(a){a=a||{},this.mapv=a.mapv,this.defaultAnchor=BMAP_ANCHOR_TOP_RIGHT,this.defaultOffset=new BMap.Size(10,10)}function OptionalData(a){var b=a.options;this.drawType=b.drawType,this["super"]=a,this.options=b.drawOptions,this.initCSS(),this.initDom(),this.initController(),this.bindEvent()}function BubbleDrawer(){Drawer.apply(this,arguments)}function CategoryDrawer(){Drawer.apply(this,arguments)}function ChoroplethDrawer(){Drawer.apply(this,arguments)}function ClusterDrawer(){Drawer.apply(this,arguments)}function DensityDrawer(){this.Scale,this.masker={},this.mapv=null,this.ctx=null,Drawer.apply(this,arguments)}function recGrids(a){for(var b,c,d=a.data,e=a.nwMc,f=a.gridWidth,g=a.zoomUnit,h={},i=f/g,j=parseInt(e.x/f,10)*f,k=(j-e.x)/g,l=[],m=0;k+m*i<map.getSize().width;){var n=k+m*i;l.push(n.toFixed(2)),m++}for(var o=parseInt(e.y/f,10)*f+f,p=(e.y-o)/g,q=[],r=0;p+r*i<map.getSize().height;)n=p+r*i,q.push(n.toFixed(2)),r++;for(var s=0;s<l.length;s++)for(var t=0;t<q.length;t++){var u=l[s]+"_"+q[t];h[u]=0}for(var s=0;s<d.length;s++){var v=d[s].px,w=d[s].py,x=parseInt(d[s].count,10),y=v<l[0],z=w<q[0],A=v>Number(l[l.length-1])+Number(i),B=w>Number(q[q.length-1])+Number(i);if(!(y||z||A||B)){for(var t=0;t<l.length;t++){var C=Number(l[t]);if(v>=C&&C+i>v)for(var D=0;D<q.length;D++){var E=Number(q[D]);w>=E&&E+i>w&&(h[l[t]+"_"+q[D]]+=x,x=h[l[t]+"_"+q[D]])}}c=c||x,b=b||x,c=c>x?x:c,b=x>b?x:b}}return{grids:h,max:b,min:c}}function drawRec(a){var b=a.gridWidth,c=a.zoomUnit,d=a.max,e=a.min,f=a.ctx,g=a.grids,h=a.fillColors,i=a.sup,j=b/c,k=(d-e+1)/10;for(var l in g){var m=l.split("_"),n=m[0],o=m[1],p=(g[l]-e)/k,q=h[0|p],r=i.masker.min&&g[l]<i.masker.min,s=i.masker.max&&g[l]>i.masker.max;0===g[l]||r||s?f.fillStyle="rgba(255,255,255,0.1)":f.fillStyle="rgba("+q[0]+","+q[1]+","+q[2]+",0.4)",f.fillRect(n,o,j-1,j-1),i.drawOptions.showNum&&(f.save(),f.textBaseline="top",0===g[l]||r||s||(f.fillStyle="rgba(0,0,0,0.8)",f.fillText(g[l],n,o)),f.restore())}}function honeycombGrid(a){var b,c,d=a.data,e=a.nwMc,f=a.gridWidth,g=a.zoomUnit,h=a.ctx,i={},j=f/g,k=j,l=3*j/4,m=2*f*3/4,n=parseInt(e.y/m+1,10)*m,o=(e.y-n)/g;o=parseInt(o,10);var p=k*f,q=parseInt(e.x/p,10)*p,r=(q-e.x)/g;r=parseInt(r,10);for(var s=parseInt(h.canvas.width+p/g,10),t=parseInt(h.canvas.height+m/g,10),u=r,v=o,w=!1;t>v;){for(;s>u;){var x=w?u-k/2:u;x=parseInt(x,10),i[x+"|"+v]=i[x+"|"+v]||{x:x,y:v,len:0},u+=k}w=!w,u=r,v+=l}for(var y in d){var z=d[y].count,A=d[y].px,B=d[y].py,C=Math.round((B-o)/l),D=C*l+o,E=Math.round((A-r)/k),F=E*k+r;if(C%2&&(F-=k/2),!(r>F||F>s||o>D||D>t)&&i[F+"|"+D]){i[F+"|"+D].len+=z;var G=i[F+"|"+D].len;b=b||G,c=c||G,b=Math.max(b,G),c=Math.min(c,G)}}return{grids:i,max:b,min:c}}function drawHoneycomb(a){var b=a.ctx,c=a.grids,d=a.gridWidth/a.zoomUnit,e=a.fillColors,f=(a.max-a.min-1)/e.length;for(var g in c){var h=c[g].x,i=c[g].y,j=c[g].len,k=j/f|0;k=k>=e.length?e.length-1:k,k=0>k?0:k;var l="rgba("+e[k].join(",")+",0.6)";console.log();var m=a.sup.masker.min&&a.sup.masker.min>j,n=a.sup.masker.max&&a.sup.masker.max<j;j>0&&!m&&!n?draw(h,i,d-1,l,b):draw(h,i,d-1,"rgba(0,0,0,0.2)",b),a.sup.drawOptions.showNum&&(b.save(),b.textBaseline="middle",b.textAlign="center",b.fillStyle="rgba(0,0,0,0.8)",b.fillText(j,h,i),b.restore())}}function draw(a,b,c,d,e){e.beginPath(),e.fillStyle=d,e.moveTo(a,b-c/2),e.lineTo(a+c/2,b-c/4),e.lineTo(a+c/2,b+c/4),e.lineTo(a,b+c/2),e.lineTo(a-c/2,b+c/4),e.lineTo(a-c/2,b-c/4),e.fill(),e.closePath()}function formatParam(){var a=this.drawOptions,b=this.fillColors=[[73,174,34],[119,191,26],[160,205,18],[202,221,10],[248,237,1],[225,222,3],[254,182,10],[254,126,19],[254,84,27],[253,54,32]];this.colorBar={};for(var c=0;c<b.length;c++){var d=(c+1)/b.length,e=b[c][0],f=b[c][1],g=b[c][2];this.colorBar[d]="rgb("+e+","+f+","+g+")"}var h=a.gridWidth||"50";return h+=a.gridUnit||"px",h=/px$/.test(h)?parseInt(h,10)*this.zoomUnit:parseInt(h,10),{gridWidth:h,colors:b}}function Drawer(a){this.mapv=a,this.drawOptions={}}function HeatmapDrawer(){var a=this;a.masker={},Drawer.apply(this,arguments),this._max=20,this._data=[]}function IntensityDrawer(){this.masker={min:0,max:0},Drawer.apply(this,arguments),this._tmpCanvas=document.createElement("canvas"),this.gradient(this.defaultGradient)}function SimpleDrawer(){Drawer.apply(this,arguments)}var Mapv;Mapv.prototype._initDrawScale=function(){this.Scale=new DrawScale},Mapv.prototype._initOptionDataControl=function(){this.OptionalData=new OptionalData(this)},Mapv.prototype.setOptions=function(a,b){util.extend(this.options,a);var c=this._getDrawer(this.options.drawType);c.setDrawOptions(this.options.drawOptions[this.options.drawType]),void 0!==a.data&&this.geoData.setData(a.data),this.layer.draw(),c.drawDataRange?(this.options.map.addControl(this._dataRangeCtrol),c.drawDataRange(this._dataRangeCtrol.getContainer())):this.options.map.removeControl(this._dataRangeCtrol),c.scale?(c.scale(this.Scale),this.Scale.show()):this.Scale.hide(),this.OptionalData&&this.OptionalData.initController(this.options.drawType)},Mapv.prototype._initOptions=function(a){var b={drawType:"simple"};a=a||{},this.options=util.extend(b,a)},Mapv.prototype._initLayer=function(){var a=this;this.layer=new Layer(this.options.map,this,function(b){var c=a.options.drawType||"simple";a.ctx=b,a._getDrawer(c).drawMap(a,b,a.options.data)})},Mapv.prototype._initGeodata=function(){this.geoData=new GeoData(this)},Mapv.prototype._initDataRange=function(){this._dataRangeCtrol=new DataRangeControl,this.options.map.addControl(this._dataRangeCtrol)},Mapv.prototype._initDrawer=function(){this._drawer={}},Mapv.prototype._initDrawTypeControl=function(){this._drawTypeControl=new DrawTypeControl({mapv:this}),this.options.map.addControl(this._drawTypeControl)},Mapv.prototype._getDrawer=function(drawType){if(this._drawer||this._initDrawer(),!this._drawer[drawType]){var funcName=drawType.replace(/(\w)/,function(a){return a.toUpperCase()});funcName+="Drawer";var drawer=this._drawer[drawType]=eval("(new "+funcName+"(this))");drawer.scale?(drawer.scale(this.Scale),this.Scale.show()):this.Scale.hide()}return this._drawer[drawType]},Mapv.prototype.getMap=function(){return this.options.map},Mapv.prototype.getDataRangeCtrol=function(){return this._dataRangeCtrol},Mapv.prototype.getOptions=function(){return this.options};var util={isPlainObject:function(a){var b,c={},d=c.hasOwnProperty;if(!a||"object"!=typeof a||a.nodeType)return!1;var e=!d.call(a,"constructor"),f=!d.call(a.constructor.prototype,"isPrototypeOf");if(a.constructor&&e&&f)return!1;for(b in a);return void 0===b||d.call(a,b)},extend:function(a,b){var c,d=Object.prototype.toString,e="[object Array]";a=a||{};for(c in b)b.hasOwnProperty(c)&&(util.isPlainObject(b[c])?(a[c]=d.call(b[c])===e?[]:{},arguments.callee(a[c],b[c]),a[c]=b[c]):a[c]=b[c]);return a},copy:function(a){return this.extend({},a)},inherits:function(a,b){var c,d,e=a.prototype,f=new Function;f.prototype=b.prototype,d=a.prototype=new f;for(c in e)d[c]=e[c];a.prototype.constructor=a,a.superClass=b.prototype},addCssByStyle:function(a){var b=document,c=b.createElement("style");if(c.setAttribute("type","text/css"),c.styleSheet)c.styleSheet.cssText=a;else{var d=b.createTextNode(a);c.appendChild(d)}var e=b.getElementsByTagName("head");e.length?e[0].appendChild(c):b.documentElement.appendChild(c)}};Layer.prototype.draw=function(){var a=this.ctx;a.clearRect(0,0,a.canvas.width,a.canvas.height),a.canvas.width=a.canvas.width,a.canvas.height=a.canvas.height,this.mapv.geoData.calculatePixel(),this.drawCbk.call(this,a)},MapMask.prototype=new BMap.Overlay,MapMask.prototype.initialize=function(a){this._map=a;var b=this.options.elementTag||"div",c=this.element=document.createElement(b),d=a.getSize();return c.width=d.width,c.height=d.height,c.style.cssText="position:absolute;left:0;top:0;width:"+d.width+"px;height:"+d.height+"px",a.getPanes().labelPane.appendChild(this.element),this.element},MapMask.prototype.initElement=function(a){},MapMask.prototype.draw=function(){var a=this._map,b=a.getBounds(),c=b.getSouthWest(),d=b.getNorthEast(),e=a.pointToOverlayPixel(new BMap.Point(c.lng,d.lat));this.element.style.left=e.x+"px",this.element.style.top=e.y+"px",this.dispatchEvent("draw")},MapMask.prototype.getContainer=function(){return this.element},MapMask.prototype.show=function(){this._map.addOverlay(this)},MapMask.prototype.hide=function(){this._map.removeOverlay(this)},GeoData.prototype.calculatePixel=function(){for(var a=map.getZoom(),b=Math.pow(2,18-a),c=mercatorProjection.lngLatToPoint(map.getCenter()),d=new BMap.Pixel(c.x-map.getSize().width/2*b,c.y+map.getSize().height/2*b),e=this.data,f=0;f<e.length;f++){if(e[f].lng&&e[f].lat){var g=this.map.pointToPixel(new BMap.Point(e[f].lng,e[f].lat));e[f].px=g.x,e[f].py=g.y}e[f].x&&e[f].y&&(e[f].px=(e[f].x-d.x)/b,e[f].py=(d.y-e[f].y)/b)}},GeoData.prototype.getData=function(){return this.data},GeoData.prototype.setData=function(a){if(!a)return void(this.data=[]);this._min=a[0].count,this._max=a[0].count;for(var b=0;b<a.length;b++)this._max=Math.max(this._max,a[b].count),this._min=Math.min(this._min,a[b].count);this.data=a},GeoData.prototype.getDataRange=function(){return{min:this._min,max:this._max}},DataControl.prototype.initHistory=function(){var a=localStorage.getItem("filenames");a=JSON.parse(a),this.history.innerHTML="";var b=["bit","KB","MB","GB"];for(var c in a){var d=a[c].name,e=a[c].size,f=document.createElement("a");f.setAttribute("storageName",c);for(var g=0;e>1024;)e=parseInt(e/1024,10),g++;f.href="#",f.style.color="orange",f.style.marginRight="10px",f.textContent=d+"("+e+b[g]+")  ",this.history.appendChild(f)}},DataControl.prototype.initDom=function(){var a=this.control=document.createElement("div"),b=this.input=document.createElement("input");b.type="file";var c=document.createElement("div");c.textContent="自定义数据：";var d=document.createElement("div");d.textContent="拖拽文件到窗口或者选择自定义文件",a.appendChild(c),a.appendChild(d),a.appendChild(b),a.style.fontSize="12px",a.style.lineHeight="1.8em",a.style.position="absolute",a.style.bottom="50px",a.style.left="10px",a.style.padding="10px 20px",a.style.color="#FFF",a.style.background="rgba(0,0,0,0.5)",a.style.zIndex="100000",a.style.overflow="hidden",a.style.webkitTransition="all 0.5s ease-in";var e=document.createElement("div"),f=document.createElement("div");f.textContent="历史数据",this.history=document.createElement("div"),e.appendChild(f),e.appendChild(this.history),a.appendChild(e),document.body.appendChild(a)},DataControl.prototype.initEvent=function(){function a(a){var c,d=!1;try{c=JSON.parse(a.replace(/\s/g,""));for(var e=0;"string"==typeof c&&10>=e;)c=JSON.parse(c),e++;d=!1}catch(f){d=!0}if(d)try{c=[];var g=a.split("\n");g.length<=1&&(g=a.split("\\n"));for(var h=g[0].split(","),i=1;i<h.length;i++){for(var j=g[i].split(","),k={},l=0,m=0;m<j.length;m++){var n=h[m]||"noname"+l++;n=n.replace(/\\r/g,""),k[n]=Number(j[m].replace(/\\r/g,"").replace(/\"/g,""))}c.push(k)}c=JSON.stringify(c).replace(/\\r/g,""),c=JSON.parse(c),d=!1}catch(f){window.console.log(f),d=!0}return d?(alert("数据格式错误，请检查是否为json或者csv格式数据"),!1):(b.geoData.setData(c),b["super"].layer.draw(),!0)}var b=this,c=new FileReader;c.addEventListener("load",function(d){var e=c.result,f=a(e);if(f){var g=localStorage.getItem("filenames")||"{}";if(g=JSON.parse(g),!c.fileName||!c.fileSize)return console.log("no fileName or fileSize , save faild "),!1;for(var h in g)if(g[h].name===this.fileName&&g[h].size===this.fileSize)return!1;var i=this.fileName+this.fileSize+parseInt(1e17*Math.random(),10).toString(36);g[i]={size:this.fileSize,name:this.fileName},localStorage.setItem("filenames",JSON.stringify(g)),localStorage.setItem(i,JSON.stringify(e)),b.initHistory()}}),b.history.addEventListener("click",function(b){var c=b.target;if("A"===c.nodeName){var d=c.getAttribute("storageName"),e=localStorage.getItem(d);a(e)}return!1}),b.input.addEventListener("change",function(a){c.readAsText(a.target.files[0]),c.fileName=a.target.files[0].name,c.fileSize=a.target.files[0].size}),document.addEventListener("dragover",function(a){a.preventDefault()},!1),document.addEventListener("drop",function(a){return a.preventDefault(),c.readAsText(a.dataTransfer.files[0]),c.fileName=a.dataTransfer.files[0].name,c.fileSize=a.dataTransfer.files[0].size,!1})},DataRangeControl.prototype=new BMap.Control,DataRangeControl.prototype.initialize=function(a){var b=this.canvas=document.createElement("canvas");return b.style.background="#fff",b.style.boxShadow="rgba(0,0,0,0.2) 0 0 4px 2px",b.style.border="1px solid #999999",b.style.borderRadius="4px",a.getContainer().appendChild(b),b},DataRangeControl.prototype.getContainer=function(a){return this.canvas},DrawScale.prototype.change=function(a){var b=this;b.changeFn=a},DrawScale.prototype.hide=function(){var a=this;a.box.style.display="none"},DrawScale.prototype.show=function(){var a=this;a.box.style.display="block"},DrawScale.prototype.set=function(a){var b=this;b.max=a.max||b.max,b.min=a.min||b.min,b.colors=a.colors||b.colors,b._draw()},DrawScale.prototype.init=function(){var a=this;a.changeFn=null,a.width=55,a.height=250,a.min=0,a.max=100,a.offsetTop=10,a.offsetBottom=10,a.drawHeight=a.height-a.offsetTop-a.offsetBottom,a.colors=["#49ae22","#77c01a","#a0cd12","#cadd0a","#f8ed01","#e1de03","#feb60a","#fe7e13","#fe571b","#fd3620"],a.defaultColors=["#49ae22","#77c01a","#a0cd12","#cadd0a","#f8ed01","#e1de03","#feb60a","#fe7e13","#fe571b","#fd3620"],a.point={x:0,y:0},a.hoveredHandle=null,a.showHandle=!1,a.handleStartPos={val:a.min,yMin:a.offsetTop,yMax:a.offsetTop+a.drawHeight,y:a.offsetTop},a.handleEndPos={val:a.max,yMin:a.offsetTop,yMax:a.offsetTop+a.drawHeight,y:a.offsetTop+a.drawHeight};var b=a.box=document.createElement("div"),c=document.createElement("canvas");c.width=a.width,c.height=a.height,c.style.cursor="pointer",b.style.border="1px solid #999",b.style.boxShadow="rgba(0, 0, 0, 0.2) 0px 0px 4px 2px",b.style.borderRadius="6px",b.style.background="white",b.style.position="absolute",b.style.right="10px",b.style.bottom="10px",b.style.width=a.width+"px",b.style.height=a.height+"px",b.style.zIndex=1e4,b.appendChild(c),document.body.appendChild(b),a.ctx=c.getContext("2d"),a._draw()},DrawScale.prototype._Event=function(){var a=this,b=a.ctx.canvas,c=!1,d={x:0,y:0},e={y:0,name:null};b.addEventListener("mouseenter",function(){a.showHandle=!0,a._draw()}),b.addEventListener("mouseleave",function(){a.showHandle=!1,a._draw()}),b.addEventListener("mousedown",function(b){var f=a.hoveredHandle;if(f){d.x=b.pageX,d.y=b.pageY;var g="handle"+f.name+"Pos";e.name=g,e.y=a[g].y,c=!0}}),window.addEventListener("mousemove",function(b){if(a.point.x=b.offsetX,a.point.y=b.offsetY,c){var f=b.pageY-d.y;a[e.name].y=e.y+f;var g=e.y+f,h=a[e.name].yMax,i=a[e.name].yMin;g=g>h?h:g,g=i>g?i:g,a[e.name].y=g,"handleStartPos"===e.name&&(a.handleEndPos.yMin=g),"handleEndPos"===e.name&&(a.handleStartPos.yMax=g),b.preventDefault()}a._draw()}),window.addEventListener("mouseup",function(b){c&&(a.changeFn&&a.changeFn(a.handleStartPos.val,a.handleEndPos.val),c=!1)})},DrawScale.prototype._draw=function(){var a=this,b=a.ctx;b.clearRect(0,0,b.canvas.width,b.canvas.height),a.hoveredHandle=null;var c,d=5,e=a.offsetTop,f=10,g=a.drawHeight;c="default"===a.colors?a.defaultColors:a.colors;var h=b.createLinearGradient(d,e,f,g),i=g/(c.length-1);if(a.colors instanceof Array||"default"===a.colors)for(var j=0;j<c.length;j++){var k=j*i/a.height;h.addColorStop(k,c[j])}else if("object"==typeof a.colors)for(var j in a.colors)h.addColorStop(j,a.colors[j]);b.fillStyle=b.strokeStyle=h,b.fillRect(d,e,f,g);var l=(a.handleStartPos.y-e)/g*a.max|0,m=a.handleStartPos.val=l+a.min,n=a.handleEndPos.val=(a.handleEndPos.y-e)/g*a.max|0;b.textAlign="left",b.textBaseline="middle";var o=d+f+5;b.fillText("- "+a.min,o,e),b.fillText("- "+a.max,o,e+g),b.save(),b.fillStyle="grey",a.handleStartPos.y>e+10&&b.fillText("- "+m,o,a.handleStartPos.y),a.handleEndPos.y<e+g-10&&b.fillText("- "+n,o,a.handleEndPos.y),b.restore(),a.showHandle&&(drawTips({sup:a,name:"Start",ctx:b,left:d+f,right:b.canvas.width-5,top:a.handleStartPos.y,text:m}),drawTips({sup:a,name:"End",ctx:b,left:d+f,right:b.canvas.width-5,top:a.handleEndPos.y,text:n})),b.save(),b.fillStyle="#ADABAB";var p=d,q=f;b.fillRect(p,e,q,a.handleStartPos.y-a.offsetTop),b.fillRect(p,a.handleEndPos.y,q,g-a.handleEndPos.y+a.offsetTop),b.restore(),a.hoveredHandle?b.canvas.style.cursor="pointer":b.canvas.style.cursor="default"},util.addCssByStyle(["#MapvDrawTypeControl { list-style:none; position:absolute; left:10px; top:10px; padding:0; margin:0; }","#MapvDrawTypeControl li{ padding:0; margin:0; cursor:pointer; margin:1px 0;","color:#fff; padding:5px; background:rgba(0, 0, 0, 0.5); }","#MapvDrawTypeControl li.current{ background:rgba(0, 0, 255, 0.5); }"].join("\n")),DrawTypeControl.prototype=new BMap.Control,DrawTypeControl.prototype.initialize=function(a){var b=this.ul=document.createElement("ul"),c=this.mapv.options.drawOptions;b.setAttribute("id","MapvDrawTypeControl");for(var d in c){var e=document.createElement("li");this.mapv.options.drawType===d&&(e.className="current"),e.setAttribute("drawType",d),e.innerHTML=d,b.appendChild(e)}var f=this;return b.addEventListener("click",function(a){var b=a.target;if("LI"===b.nodeName){for(var c=b.parentNode,d=c.getElementsByTagName("li"),e=0;e<d.length;e++)d[e].className="";var g=b.getAttribute("drawType");b.className="current",f.mapv.setOptions({drawType:g})}}),a.getContainer().appendChild(b),b},DrawTypeControl.prototype.getContainer=function(){return this.ul},OptionalData.prototype.initCSS=function(){util.addCssByStyle([".controlBox { position:absolute; left:10px; top:10px; background:rgba(0,0,0,0.5); padding:10px; }",".controlBox input {border-radius:6px; border:none; padding:10px;}",".controlBox button ","{ padding:8px 10px; border:none; width:40%; margin-left: 10px; border-radius:6px; cursor:pointer; }",".controlBoxBlock { color:#fff; padding: 10px; }",".controlBoxTitle { display:inline-block; width:100px; text-align:right; padding-right:10px; }"].join("\n"))},OptionalData.prototype.initDom=function(){var a=this.box=document.createElement("div");a.className="controlBox";var b=this.contentBox=document.createElement("div"),c=document.createElement("div");c.style.textAlign="center";var d=this.updateBtn=document.createElement("button"),e=this.resetBtn=document.createElement("button");return d.textContent="update",e.textContent="reset",a.appendChild(b),c.appendChild(d),c.appendChild(e),a.appendChild(c),document.body.appendChild(a),a},OptionalData.prototype.initController=function(a){function b(a){var b=document.createElement("div");b.className="controlBoxBlock";var e=document.createElement("span");e.textContent=a.name,e.className="controlBoxTitle";var f;if("text"===a.type||"color"===a.type){f=document.createElement("label");var g=document.createElement("input");g.name=a.name,g.value=c[a.name],g.type=a.type,f.appendChild(g)}else if("option"===a.type){f=document.createElement("span");for(var h=0;h<a.value.length;h++){var i=document.createElement("label");i.style.padding="0 10px 0  0",i.style.cursor="pointer";var j=document.createElement("input");j.type="radio",j.name=a.name,j.value=a.value[h],c[a.name]===a.value[h]&&(j.checked=!0);var k=document.createElement("span");k.textContent=a.value[h],i.appendChild(j),i.appendChild(k),f.appendChild(i)}}else if("check"===a.type){f=document.createElement("label");var g=document.createElement("input");g.type="checkbox",g.name=a.name,g.checked=c[a.name],f.appendChild(g)}else{if("json"!==a.type)return!1;f=document.createElement("label");var g=document.createElement("input");g.setAttribute("isJson",!0),g.name=a.name,g.value=JSON.stringify(c[a.name]),f.appendChild(g)}b.appendChild(e),b.appendChild(f),d.contentBox.appendChild(b)}var c,d=this;if(a){var e=d["super"]._getDrawer(a);c=d.options=e.getDrawOptions(),d.drawType=a}else c=d.options;var f=c.editable;if(!f)return d.box.style.display="none",!1;d.box.style.display="block",d.contentBox.innerHTML="";for(var g=[],h=0;h<f.length;h++){var i=f[h];"string"==typeof i&&(i={name:i,type:"text"},f[h]=i),c[i.name]&&(b(i),f[h]._oldVal=c[i.name],g.push(f[h]))}c.editable=g},OptionalData.prototype.bindEvent=function(){var a=this;this.updateBtn.onclick=function(){for(var b=0;b<a.options.editable.length;b++){var c=a.options.editable[b].name,d=a.contentBox.querySelector('input[name="'+c+'"]');d&&("radio"===d.type?(d=a.contentBox.querySelector('input[name="'+c+'"]:checked'),a.options[c]=d.value):"checkbox"===d.type?(d=a.contentBox.querySelector('input[name="'+c+'"]'),a.options[c]=d.checked):"true"===d.getAttribute("isJson")?(console.log(1),a.options[c]=JSON.parse(d.value)):a.options[c]=d.value)}var e=a["super"]._getDrawer(a.drawType);e.setDrawOptions(a.options),a["super"].layer.draw()},this.resetBtn.onclick=function(){for(var b=0;b<a.options.editable.length;b++){var c=a.options.editable[b].name,d=a.options.editable[b]._oldVal;a.options[c]=d}var e=a["super"]._getDrawer(a.drawType);e.setDrawOptions(a.options),a["super"].layer.draw(),a.initController()}},util.inherits(BubbleDrawer,Drawer),BubbleDrawer.prototype.drawMap=function(a,b){var c=a.geoData.getData();b.save();var d=this.drawOptions;d.globalCompositeOperation&&(b.globalCompositeOperation=d.globalCompositeOperation),b.fillStyle=d.fillStyle||"rgba(50, 50, 200, 0.8)",b.strokeStyle=d.strokeStyle,b.lineWidth=d.lineWidth||1;for(var e=0,f=c.length;f>e;e++){var g=c[e],h=this.getRadius(g.count);b.beginPath(),b.arc(g.px,g.py,h,0,2*Math.PI,!1),b.closePath(),b.fill(),d.strokeStyle&&b.stroke()}b.restore()},BubbleDrawer.prototype.getRadius=function(a){for(var b=1,c=this.splitList,d=0;d<c.length;d++)if((void 0===c[d].start||void 0!==c[d].start&&a>=c[d].start)&&(void 0===c[d].end||void 0!==c[d].end&&a<c[d].end)){b=c[d].radius;break}return b},BubbleDrawer.prototype.drawDataRange=function(){var a=this.mapv.getDataRangeCtrol().getContainer();a.width=100,a.height=190,a.style.width="100px",a.style.height="190px";var b=a.getContext("2d");b.fillStyle=this.drawOptions.fillStyle||"rgba(50, 50, 200, 0.8)";for(var c=this.splitList,d=0;d<c.length;d++){b.beginPath(),b.arc(15,25*d+20,c[d].radius,0,2*Math.PI,!1);var e=c[d].start||"~",f=c[d].end||"~",g=e+" - "+f;b.fillText(g,25,25*d+25),b.closePath(),b.fill()}},util.inherits(CategoryDrawer,Drawer),CategoryDrawer.prototype.drawMap=function(a,b){var c=a.geoData.getData(),d=this.drawOptions;b.strokeStyle=d.strokeStyle;for(var e=d.radius,f=0,g=c.length;g>f;f++){var h=c[f];b.beginPath(),b.moveTo(h.px,h.py),b.fillStyle=this.getColor(h.count),b.arc(h.px,h.py,e,0,2*Math.PI),b.closePath(),b.fill()}d.strokeStyle&&b.stroke()},CategoryDrawer.prototype.generalSplitList=function(){this.splitList={other:"rgba(255, 255, 0, 0.8)",1:"rgba(253, 98, 104, 0.8)",2:"rgba(255, 146, 149, 0.8)",3:"rgba(255, 241, 193, 0.8)",4:"rgba(110, 176, 253, 0.8)",5:"rgba(52, 139, 251, 0.8)",6:"rgba(17, 102, 252)"}},CategoryDrawer.prototype.drawDataRange=function(){var a=this.mapv.getDataRangeCtrol().getContainer();a.width=80,a.height=190,a.style.width="80px",a.style.height="190px";var b=a.getContext("2d"),c=this.splitList,d=0;for(var e in c)b.fillStyle=c[e],b.beginPath(),b.arc(15,25*d+15,5,0,2*Math.PI,!1),b.closePath(),b.fill(),b.fillStyle="#333",b.fillText(e,25,25*d+20),d++},CategoryDrawer.prototype.getColor=function(a){var b=this.splitList,c=b.other;for(var d in b)if(a==d){c=b[d];break}return c},util.inherits(ChoroplethDrawer,Drawer),ChoroplethDrawer.prototype.drawMap=function(a,b){var c=a.geoData.getData(),d=this.drawOptions;b.strokeStyle=d.strokeStyle;for(var e=0,f=c.length;f>e;e++){var g=c[e];b.fillStyle=this.getColor(g.count),b.beginPath(),b.moveTo(g.px,g.py),b.arc(g.px,g.py,d.radius,0,2*Math.PI),b.closePath(),b.fill()}d.strokeStyle&&b.stroke()},ChoroplethDrawer.prototype.drawDataRange=function(){var a=this.mapv.getDataRangeCtrol().getContainer(),b=this.drawOptions;a.width=100,a.height=190,a.style.width="100px",a.style.height="190px";var c=a.getContext("2d");c.fillStyle=b.fillStyle||"rgba(50, 50, 200, 0.8)";for(var d=this.splitList,e=0;e<d.length;e++){c.fillStyle=d[e].color,c.beginPath(),c.arc(15,25*e+15,b.radius,0,2*Math.PI,!1);var f=(d[e].start||"~")+" - "+(d[e].end||"~");c.fillText(f,25,25*e+20),c.closePath(),c.fill()}},ChoroplethDrawer.prototype.getColor=function(a){for(var b=this.splitList,c="yellow",d=0;d<b.length;d++)if((void 0===b[d].start||void 0!==b[d].start&&a>=b[d].start)&&(void 0===b[d].end||void 0!==b[d].end&&a<b[d].end)){c=b[d].color;break}return c};var min,max;util.inherits(ClusterDrawer,Drawer),ClusterDrawer.prototype.drawMap=function(a,b){window.console.time("computerMapData"),max=min=void 0;for(var c=a.geoData.getData(),d=a.getMap(),e=d.getZoom(),f=this.zoomUnit=Math.pow(2,18-e),g=this.formatParam(),h=g.gridWidth,i=g.colors,j=mercatorProjection.lngLatToPoint(d.getCenter()),k=j.x-d.getSize().width/2*f,l=new BMap.Pixel(k,j.y+d.getSize().height/2*f),m=h/f,n=parseInt(l.x/h,10)*h,o=(n-l.x)/f,p=[],q=0;o+q*m<d.getSize().width;){var r=o+q*m;p.push(r.toFixed(2)),q++}for(var s=parseInt(l.y/h,10)*h+h,t=(l.y-s)/f,u=[],v=0;t+v*m<d.getSize().height;)r=t+v*m,u.push(r.toFixed(2)),v++;for(var w={},x=0;x<p.length;x++)for(var y=0;y<u.length;y++){var z=p[x]+"_"+u[y];w[z]=0}for(var x=0;x<c.length;x++){var A=c[x].px,B=c[x].py,C=parseInt(c[x].count,10),D=A<p[0],E=B<u[0],F=A>Number(p[p.length-1])+Number(m),G=B>Number(u[u.length-1])+Number(m);if(!(D||E||F||G)){for(var y=0;y<p.length;y++){var H=Number(p[y]);if(A>=H&&H+m>A)for(var I=0;I<u.length;I++){var J=Number(u[I]);B>=J&&J+m>B&&(w[p[y]+"_"+u[I]]+=C,C=w[p[y]+"_"+u[I]])}}min=min||C,max=max||C,min=min>C?C:min,max=C>max?C:max}}var K=(max-min+1)/10;window.console.timeEnd("computerMapData"),window.console.time("drawMap");for(var x in w){var L=x.split("_");A=Number(L[0]),B=Number(L[1]);var M=(w[x]-min)/K;M=0>M?0:M;var N=(i[0|M],A+m/2),O=B+m/2;b.fillStyle="#fa8b2e",b.beginPath(),b.arc(N,O,5*M,0,2*Math.PI),b.fill(),b.lineWidth=8*M/10,b.strokeStyle="#fff",b.stroke(),b.save(),b.font=30*M/10+"px serif",b.textAlign="center",b.textBaseline="middle",0!==w[x]&&(b.fillStyle="#fff",b.fillText(w[x],N,O)),b.restore()}window.console.timeEnd("drawMap")},ClusterDrawer.prototype.formatParam=function(){var a=this.drawOptions,b=this.fillColors=[[73,174,34],[119,191,26],[160,205,18],[202,221,10],[248,237,1],[225,222,3],[254,182,10],[254,126,19],[254,84,27],[253,54,32]];this.colorBar={};for(var c=0;c<b.length;c++){var d=(c+1)/b.length,e=b[c][0],f=b[c][1],g=b[c][2];this.colorBar[d]="rgb("+e+","+f+","+g+")"}var h=60;return h+=a.gridUnit||"px",h=/px$/.test(h)?parseInt(h,10)*this.zoomUnit:parseInt(h,10),{gridWidth:h,colors:b}};var min,max;util.inherits(DensityDrawer,Drawer),DensityDrawer.prototype.scale=function(a){var b=this;a.change(function(a,c){b.masker={min:a,max:c},b.ctx.clearRect(0,0,b.ctx.canvas.width,b.ctx.canvas.height),b.drawMap()}),this.Scale=a},DensityDrawer.prototype.drawMap=function(a,b){var c=this;a=this.mapv=this.mapv||a,b=this.ctx=this.ctx||b;var d=a.geoData.getData(),e=a.getMap(),f=e.getZoom(),g=this.zoomUnit=Math.pow(2,18-f),h=formatParam.call(this),i=h.gridWidth,j=mercatorProjection.lngLatToPoint(e.getCenter()),k=j.x-e.getSize().width/2*g,l=new BMap.Pixel(k,j.y+e.getSize().height/2*g);window.console.time("computerMapData");var m={data:d,nwMc:l,gridWidth:i,zoomUnit:g,ctx:b},n={};n="honeycomb"===this.drawOptions.gridType?honeycombGrid(m):recGrids(m);var o=n.grids,p=n.max,q=n.min;window.console.timeEnd("computerMapData"),window.console.time("drawMap");var m={gridWidth:i,zoomUnit:g,max:p,min:q,ctx:b,grids:o,fillColors:h.colors,sup:c},n={};"honeycomb"===this.drawOptions.gridType?drawHoneycomb(m):drawRec(m),window.console.timeEnd("drawMap"),this.Scale&&this.Scale.set({max:p,min:q,colors:"default"})},Drawer.prototype.defaultDrawOptions={radius:2},Drawer.prototype.drawMap=function(){},Drawer.prototype.setDrawOptions=function(a){var b=util.copy(this.defaultDrawOptions);this.drawOptions=util.extend(b,a),this.drawOptions.splitList?this.splitList=this.drawOptions.splitList:this.generalSplitList(),this.drawDataRange&&this.drawDataRange()},Drawer.prototype.getDrawOptions=function(){return this.drawOptions},Drawer.prototype.clearDrawOptions=function(a){this.drawOptions={}},Drawer.prototype.colors=["rgba(17, 102, 252, 0.8)","rgba(52, 139, 251, 0.8)","rgba(110, 176, 253, 0.8)","rgba(255, 241, 193, 0.8)","rgba(255, 146, 149, 0.8)","rgba(253, 98, 104, 0.8)","rgba(255, 0, 0, 0.8)","rgba(255, 51, 61, 0.8)"],Drawer.prototype.generalSplitList=function(){var a=this.mapv.geoData.getDataRange(),b=Math.ceil((a.max-a.min)/7),c=a.min;this.splitList=[];for(var d=1;c<a.max;)this.splitList.push({start:c,end:c+b,radius:d,color:this.colors[d-1]}),c+=b,d++},util.inherits(HeatmapDrawer,Drawer),HeatmapDrawer.prototype.drawMap=function(a,b){var c=this;a=c.mapv=c.mapv||a,b=c.ctx=c.ctx||b,this._ctx=b,this._map=map,this._width=b.canvas.width,this._height=b.canvas.height;var d=a.geoData.getData();this._data=d,this.drawHeatmap(),c.Scale.set({min:0,max:c.getMax(),colors:this.getGradient()})},HeatmapDrawer.prototype.scale=function(a){var b=this;a.change(function(a,c){b.masker={min:a,max:c},b.drawMap()}),b.Scale=a},util.extend(HeatmapDrawer.prototype,{defaultRadius:10,defaultGradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow","1.0":"red"},getGradient:function(){return this.drawOptions.gradient||this.defaultGradient},getRadius:function(){var a=this._map.getZoom(),b=Math.pow(2,18-a),c=this.drawOptions.radius||200;return c/b},getMax:function(){var a=this._max;if(void 0!==this.drawOptions.max)a=this.drawOptions.max;else{var b=this.mapv.geoData.getDataRange();a=b.min+.7*(b.max-b.min)}return a},data:function(a){return this._data=a,this},max:function(a){return this._max=a,this},add:function(a){return this._data.push(a),this},clear:function(){return this._data=[],this},radius:function(a,b){b=b||15;var c=this._circle=document.createElement("canvas"),d=c.getContext("2d"),e=this._r=a+b;return"rect"===this.drawOptions.type?c.width=c.height=e:c.width=c.height=2*e,d.shadowOffsetX=d.shadowOffsetY=200,this.drawOptions.blur&&(d.shadowBlur=b),d.shadowColor="black",d.beginPath(),"rect"===this.drawOptions.type?d.fillRect(-200,-200,c.width,c.height):d.arc(e-200,e-200,a,0,2*Math.PI,!0),d.closePath(),d.fill(),this},gradient:function(a){var b=document.createElement("canvas"),c=b.getContext("2d"),d=c.createLinearGradient(0,0,0,256);b.width=1,b.height=256;for(var e in a)d.addColorStop(e,a[e]);return c.fillStyle=d,c.fillRect(0,0,1,256),this._grad=c.getImageData(0,0,1,256).data,this},drawHeatmap:function(a){this.radius(this.getRadius()),this.gradient(this.getGradient());var b=this._ctx;b.clearRect(0,0,this._width,this._height);for(var c,d=0,e=this._data.length;e>d;d++)c=this._data[d],c.px<0||c.py<0||c.px>b.canvas.width||c.py>b.canvas.height||(b.globalAlpha=Math.max(c.count/this.getMax(),void 0===a?.05:a),b.drawImage(this._circle,c.px-this._r,c.py-this._r));
var f=b.getImageData(0,0,this._width,this._height);return this.colorize(f.data,this._grad),b.putImageData(f,0,0),this},colorize:function(a,b){var c=0,d=1024;this.masker.min&&(c=this.masker.min/this.getMax()*1024),this.masker.max&&(d=this.masker.max/this.getMax()*1024);for(var e,f=3,g=a.length;g>f;f+=4){e=4*a[f];var h=this.drawOptions.maxOpacity||.8;a[f]/256>h&&(a[f]=256*h),e&&e>=c&&d>=e?(a[f-3]=b[e],a[f-2]=b[e+1],a[f-1]=b[e+2]):a[f]=0}}}),util.inherits(IntensityDrawer,Drawer),IntensityDrawer.prototype.defaultGradient={"0.0":"yellow","1.0":"red"},IntensityDrawer.prototype.drawMap=function(a,b){var c=this;a=c.mapv=c.mapv||a,b=c.ctx=c.ctx||b,b.clearRect(0,0,b.canvas.width,b.canvas.height);var d=a.geoData.getData(),e=this.drawOptions;b.strokeStyle=e.strokeStyle;var f=b.canvas.width,g=b.canvas.height;window.console.time("drawMap");for(var h=0,i=d.length;i>h;h++){var j=d[h];if(!(j.px<0||j.px>f||j.py<0||j.py>g)){var k=c.masker.min&&j.count<c.masker.min,l=c.masker.max&&j.count>c.masker.max;k||l||(b.beginPath(),b.moveTo(j.px,j.py),b.fillStyle=this.getColor(j.count),b.arc(j.px,j.py,e.radius,0,2*Math.PI),b.closePath(),b.fill())}}window.console.timeEnd("drawMap"),e.strokeStyle&&b.stroke(),this.Scale.set({min:0,max:c.getMax(),colors:"default"})},IntensityDrawer.prototype.scale=function(a){var b=this;a.change(function(a,c){b.masker={min:a,max:c},b.drawMap()}),b.Scale=a},IntensityDrawer.prototype.getMax=function(){var a=this.mapv.geoData.getDataRange(),b=a.max;return this.drawOptions.max&&(b=this.drawOptions.max),b},IntensityDrawer.prototype.getColor=function(a){var b=this.getMax(),c=a/b;c>1&&(c=1),c*=255,c=parseInt(c,10),c*=4;var d="rgba("+this._grad[c]+", "+this._grad[c+1]+", "+this._grad[c+2]+",0.8)";return d},IntensityDrawer.prototype.gradient=function(a){var b=document.createElement("canvas"),c=b.getContext("2d"),d=c.createLinearGradient(0,0,0,256);b.width=1,b.height=256;for(var e in a)d.addColorStop(e,a[e]);return c.fillStyle=d,c.fillRect(0,0,1,256),this._grad=c.getImageData(0,0,1,256).data,this},util.inherits(SimpleDrawer,Drawer),SimpleDrawer.prototype.drawMap=function(a,b){var c=a.geoData.getData(),d=this.drawOptions;b.fillStyle=d.fillStyle||"rgba(50, 50, 200, 0.8)",b.strokeStyle=d.strokeStyle,b.beginPath(),d.globalCompositeOperation&&(b.globalCompositeOperation=d.globalCompositeOperation);for(var e=d.radius||3,f=0,g=c.length;g>f;f++){var h=c[f];h.px<0||h.px>b.canvas.width||h.py<0||h>b.canvas.height||(b.moveTo(h.px,h.py),b.arc(h.px,h.py,e,0,2*Math.PI))}d.strokeStyle&&b.stroke(),b.fill()},"function"==typeof define&&define.amd?define(Mapv):"object"==typeof module&&module.exports&&(module.exports=Mapv),this.Mapv=Mapv}();