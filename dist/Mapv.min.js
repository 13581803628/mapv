!function(){function Class(){this.__listeners={}}function Mapv(a){Class.call(this),this.initOptions($.extend({map:null,drawTypeControl:!1,drawTypeControlOptions:{a:1},dataRangeCtrol:null},a)),this._layers=[],this._initDrawScale(),this.notify("drawTypeControl")}function CanvasLayer(a){this.options=a||{},this.paneName=this.options.paneName||"labelPane",this.zIndex=this.options.zIndex||0,this._map=a.map,this.show()}function Layer(a){Class.call(this),this._drawer={},this.initOptions($.extend({ctx:null,animationCtx:null,mapv:null,map:null,data:[],dataType:"point",animationOptions:{radius:5},coordType:"bd09ll",drawType:"simple",animation:!1,geometry:null,zIndex:1},a)),this.notify("data"),this.notify("mapv")}function DataControl(a){this.initDom(),this.initEvent(),this["super"]=a,this.geoData=a.geoData}function DataRangeControl(){this.defaultAnchor=BMAP_ANCHOR_BOTTOM_RIGHT,this.defaultOffset=new BMap.Size(10,10)}function DrawScale(){this.init(),this._Event()}function drawTips(a){var b=a.left,c=a.right,d=a.top,e=a.ctx;e.beginPath(),e.moveTo(b+8,d-7),e.lineTo(c,d-7),e.lineTo(c,d+7),e.lineTo(b+8,d+7),e.lineTo(b,d),e.fill();var f=e.isPointInPath(a.sup.point.x,a.sup.point.y);f&&(a.sup.hoveredHandle=a),e.save(),e.fillStyle="white",e.fillText(a.text,b+8,d),e.restore()}function DrawTypeControl(a){Class.call(this),a=a||{},this.initOptions($.extend({mapv:null,drawTypeControlOptions:{},layer:null},a)),this.bindTo("drawTypeControlOptions",this.getMapv()),this.mapv=a.mapv,this.defaultAnchor=BMAP_ANCHOR_TOP_RIGHT,this.defaultOffset=new BMap.Size(10,10)}function OptionalData(a){var b=a.options||{};this.drawType=b.drawType,this["super"]=a,this.options=b.drawOptions||{},this.initCSS(),this.initDom(),this.bindEvent()}function Drawer(a){Class.call(this),this.mapv=a._mapv,this.initOptions({layer:a,map:a.getMap(),ctx:null,mapv:null,animationOptions:{},drawOptions:{radius:2}}),this.bindTo("ctx",a),this.bindTo("animationOptions",a),this.bindTo("drawOptions",a),this.bindTo("mapv",a),this.bindTo("map",a)}function BubbleDrawer(){Drawer.apply(this,arguments)}function CategoryDrawer(){Drawer.apply(this,arguments)}function ChoroplethDrawer(){Drawer.apply(this,arguments)}function ClusterDrawer(){Drawer.apply(this,arguments)}function DensityDrawer(){this.Scale,this.masker={},Drawer.apply(this,arguments)}function recGrids(a){for(var b,c,d=a.data,e=a.nwMc,f=a.gridWidth,g=a.zoomUnit,h={},i=f/g,j=parseInt(e.x/f,10)*f,k=(j-e.x)/g,l=[],m=0;k+m*i<map.getSize().width;){var n=k+m*i;l.push(n.toFixed(2)),m++}for(var o=parseInt(e.y/f,10)*f+f,p=(e.y-o)/g,q=[],r=0;p+r*i<map.getSize().height;)n=p+r*i,q.push(n.toFixed(2)),r++;for(var s=0;s<l.length;s++)for(var t=0;t<q.length;t++){var u=l[s]+"_"+q[t];h[u]=0}for(var s=0;s<d.length;s++){var v=d[s].px,w=d[s].py,x=parseInt(d[s].count,10),y=v<l[0],z=w<q[0],A=v>Number(l[l.length-1])+Number(i),B=w>Number(q[q.length-1])+Number(i);if(!(y||z||A||B)){for(var t=0;t<l.length;t++){var C=Number(l[t]);if(v>=C&&C+i>v)for(var D=0;D<q.length;D++){var E=Number(q[D]);w>=E&&E+i>w&&(h[l[t]+"_"+q[D]]+=x,x=h[l[t]+"_"+q[D]])}}c=c||x,b=b||x,c=c>x?x:c,b=x>b?x:b}}return{grids:h,max:b,min:c}}function drawRec(a){var b=a.gridWidth,c=a.zoomUnit,d=a.max,e=a.min,f=a.ctx,g=a.grids,h=a.fillColors,i=a.sup,j=b/c,k=(d-e+1)/10;for(var l in g){var m=l.split("_"),n=m[0],o=m[1],p=(g[l]-e)/k,q=h[0|p],r=i.masker.min&&g[l]<i.masker.min,s=i.masker.max&&g[l]>i.masker.max;0===g[l]||r||s?f.fillStyle="rgba(255,255,255,0.1)":f.fillStyle="rgba("+q[0]+","+q[1]+","+q[2]+",0.4)",f.fillRect(n,o,j-1,j-1),i.getDrawOptions().showNum&&(f.save(),f.textBaseline="top",0===g[l]||r||s||(f.fillStyle="rgba(0,0,0,0.8)",f.fillText(g[l],n,o)),f.restore())}}function honeycombGrid(a){var b,c,d=a.data,e=a.nwMc,f=a.gridWidth,g=a.zoomUnit,h=a.ctx,i={},j=f/g,k=j,l=3*j/4,m=2*f*3/4,n=parseInt(e.y/m+1,10)*m,o=(e.y-n)/g;o=parseInt(o,10);var p=k*f,q=parseInt(e.x/p,10)*p,r=(q-e.x)/g;r=parseInt(r,10);for(var s=parseInt(h.canvas.width+p/g,10),t=parseInt(h.canvas.height+m/g,10),u=r,v=o,w=!1;t>v;){for(;s>u;){var x=w?u-k/2:u;x=parseInt(x,10),i[x+"|"+v]=i[x+"|"+v]||{x:x,y:v,len:0},u+=k}w=!w,u=r,v+=l}for(var y in d){var z=d[y].count,A=d[y].px,B=d[y].py,C=Math.round((B-o)/l),D=C*l+o,E=Math.round((A-r)/k),F=E*k+r;if(C%2&&(F-=k/2),!(r>F||F>s||o>D||D>t)&&i[F+"|"+D]){i[F+"|"+D].len+=z;var G=i[F+"|"+D].len;b=b||G,c=c||G,b=Math.max(b,G),c=Math.min(c,G)}}return{grids:i,max:b,min:c}}function drawHoneycomb(a){var b=a.ctx,c=a.grids,d=a.gridWidth/a.zoomUnit,e=a.fillColors,f=(a.max-a.min-1)/e.length;for(var g in c){var h=c[g].x,i=c[g].y,j=c[g].len,k=j/f|0;k=k>=e.length?e.length-1:k,k=0>k?0:k;var l="rgba("+e[k].join(",")+",0.6)",m=a.sup.masker.min&&a.sup.masker.min>j,n=a.sup.masker.max&&a.sup.masker.max<j;j>0&&!m&&!n?draw(h,i,d-1,l,b):draw(h,i,d-1,"rgba(0,0,0,0.4)",b),!a.sup.getDrawOptions().showNum||m||n||(b.save(),b.textBaseline="middle",b.textAlign="center",b.fillStyle="rgba(0,0,0,0.8)",b.fillText(j,h,i),b.restore())}}function draw(a,b,c,d,e){e.beginPath(),e.fillStyle=d,e.moveTo(a,b-c/2),e.lineTo(a+c/2,b-c/4),e.lineTo(a+c/2,b+c/4),e.lineTo(a,b+c/2),e.lineTo(a-c/2,b+c/4),e.lineTo(a-c/2,b-c/4),e.fill(),e.closePath()}function formatParam(){var a=this.getDrawOptions(),b=this.fillColors=[[73,174,34],[119,191,26],[160,205,18],[202,221,10],[248,237,1],[225,222,3],[254,182,10],[254,126,19],[254,84,27],[253,54,32]];this.colorBar={};for(var c=0;c<b.length;c++){var d=(c+1)/b.length,e=b[c][0],f=b[c][1],g=b[c][2];this.colorBar[d]="rgb("+e+","+f+","+g+")"}var h=a.gridWidth||"50";return h+=a.gridUnit||"px",h=/px$/.test(h)?parseInt(h,10)*this.zoomUnit:parseInt(h,10),{gridWidth:h,colors:b}}function HeatmapDrawer(){var a=this;a.masker={},Drawer.apply(this,arguments),this._max=20,this._data=[]}function IntensityDrawer(){this.masker={min:0,max:0},Drawer.apply(this,arguments),this._tmpCanvas=document.createElement("canvas"),this.gradient(this.defaultGradient)}function SimpleDrawer(){Drawer.apply(this,arguments)}var Mapv,util={isPlainObject:function(a){var b,c={},d=c.hasOwnProperty;if(!a||"object"!=typeof a||a.nodeType)return!1;var e=!d.call(a,"constructor"),f=!d.call(a.constructor.prototype,"isPrototypeOf");if(a.constructor&&e&&f)return!1;for(b in a);return void 0===b||d.call(a,b)},extend:function(a,b){var c,d=Object.prototype.toString,e="[object Array]";a=a||{};for(c in b)b.hasOwnProperty(c)&&(util.isPlainObject(b[c])?(a[c]=d.call(b[c])===e?[]:{},arguments.callee(a[c],b[c]),a[c]=b[c]):a[c]=b[c]);return a},copy:function(a){return this.extend({},a)},inherits:function(a,b){var c,d,e=a.prototype,f=new Function;f.prototype=b.prototype,d=a.prototype=new f;for(c in e)d[c]=e[c];a.prototype.constructor=a,a.superClass=b.prototype},addCssByStyle:function(a){var b=document,c=b.createElement("style");if(c.setAttribute("type","text/css"),c.styleSheet)c.styleSheet.cssText=a;else{var d=b.createTextNode(a);c.appendChild(d)}var e=b.getElementsByTagName("head");e.length?e[0].appendChild(c):b.documentElement.appendChild(c)}},MVCObject;!function(){function a(a,b){var c=this;c.target=a,c.targetKey=b}a.prototype.transform=function(a,b){var c=this;return c.from=a,c.to=b,c.target.notify(c.targetKey),c},MVCObject=function(){function b(a){return a.substr(0,1).toUpperCase()+a.substr(1)}function c(a){return a[n]||(a[n]=++k)}function d(a){return"_"+a}function e(a){return i.hasOwnProperty(a)?i[a]:i[a]="get"+b(a)}function f(a){return j.hasOwnProperty(a)?j[a]:j[a]="set"+b(a)}function g(a,b){var c=b+"_changed";if(a[c]?a[c]():"function"==typeof a.changed&&a.changed(b),a[l]&&a[l][b]){var d,e,f=a[l][b];for(e in f)f.hasOwnProperty(e)&&(d=f[e],g(d.target,d.targetKey))}}function h(){}var i={},j={},k=0,l="__bindings__",m="__accessors__",n="__uid__",o=h.prototype;return o.get=function(a){var b=this;if(b[m]&&b[m].hasOwnProperty(a)){var c,f=b[m][a],g=f.targetKey,h=f.target,i=e(g);c=h[i]?h[i]():h.get(g),f.to&&(c=f.to(c))}else b.hasOwnProperty(d(a))&&(c=b[d(a)]);return c},o.set=function(a,b){var c=this;if(c[m]&&c[m].hasOwnProperty(a)){var e=c[m][a],h=e.targetKey,i=e.target,j=f(h);e.from&&(b=e.from(b)),i[j]?i[j](b):i.set(h,b)}else this[d(a)]=b,g(c,a);return c},o.changed=function(){},o.notify=function(a){var b=this;if(b[m]&&b[m].hasOwnProperty(a)){var c=b[m][a],d=c.targetKey,e=c.target;e.notify(d)}else g(b,a);return b},o.setValues=function(a){var b,c,d,e=this;for(b in a)a.hasOwnProperty(b)&&(d=a[b],c=f(b),e[c]?e[c](d):e.set(b,d));return e},o.setOptions=o.setValues,o.bindTo=function(b,d,e,f){e||(e=b);var h=this;h.unbind(b),h[m]||(h[m]={}),d[l]||(d[l]={}),d[l][e]||(d[l][e]={});var i=new a(h,b),j=new a(d,e);return h[m][b]=j,d[l][e][c(h)]=i,f||g(h,b),j},o.unbind=function(a){var b=this;if(b[m]){var e=b[m][a];if(e){var f=e.target,g=e.targetKey;b[d(a)]=b.get(a),delete f[l][g][c(b)],delete b[m][a]}}return b},o.unbindAll=function(){var a=this;if(a[m]){var b=a[m];for(var c in b)b.hasOwnProperty(c)&&a.unbind(c)}return a},o.initOptions=function(a){for(var b in a)this[e(b)]=function(a){return function(){return this.get(a)}}(b),this[f(b)]=function(a){return function(b){this.set(a,b)}}(b),this[d(b)]=a[b]},h}()}(),Mapv.MVCObject=MVCObject,util.inherits(Class,MVCObject),Class.prototype.addEventListener=function(a,b){return"object"!=typeof this.__listeners[a]&&(this.__listeners[a]=[]),this.__listeners[a].push(b),this},Class.prototype.removeEventListener=function(a,b){var c=this.__listeners[a];if(!c)return!1;for(var d=c.length;d>=0;d--)c[d]===b&&c.splice(d,1);return this},Class.prototype.dispatchEvent=function(a,b){var c=util.extend({},b),d=this.__listeners[a];if(!d)return!1;for(var e=d.length-1;e>=0;e--)d[e].call(this,c);return this},Class.prototype.dispose=function(){},util.inherits(Mapv,Class),Mapv.prototype._initDrawScale=function(){this.Scale=new DrawScale},Mapv.prototype._initDataRange=function(){this.setDataRangeCtrol(new DataRangeControl),this.getMap().addControl(this.getDataRangeCtrol())},Mapv.prototype.drawTypeControl_changed=function(){this.getDrawTypeControl()?(console.log(this.getMap()),this.drawTypeControl||(this.drawTypeControl=new DrawTypeControl({mapv:this})),this.getMap().addControl(this.drawTypeControl)):this.drawTypeControl&&this.getMap().removeControl(this.drawTypeControl)},CanvasLayer.prototype=new BMap.Overlay,CanvasLayer.prototype.initialize=function(a){this._map=a;var b=this.canvas=document.createElement("canvas"),c=a.getSize();return b.width=c.width,b.height=c.height,b.style.cssText="position:absolute;left:0;top:0;z-index:"+this.zIndex+";width:"+c.width+"px;height:"+c.height+"px",a.getPanes()[this.paneName].appendChild(b),this.canvas},CanvasLayer.prototype.draw=function(){var a=this._map,b=a.getBounds(),c=b.getSouthWest(),d=b.getNorthEast(),e=a.pointToOverlayPixel(new BMap.Point(c.lng,d.lat));this.canvas.style.left=e.x+"px",this.canvas.style.top=e.y+"px",this.dispatchEvent("draw"),this.options.update&&this.options.update.call(this)},CanvasLayer.prototype.getContainer=function(){return this.canvas},CanvasLayer.prototype.show=function(){this._map.addOverlay(this)},CanvasLayer.prototype.hide=function(){this._map.removeOverlay(this)},CanvasLayer.prototype.setZIndex=function(a){this.canvas.style.zIndex=a},CanvasLayer.prototype.getZIndex=function(){return this.zIndex},util.inherits(Layer,Class),util.extend(Layer.prototype,{initialize:function(){if(!this.canvasLayer){this.bindTo("map",this.getMapv());var a=this;this.canvasLayer=new CanvasLayer({map:this.getMap(),zIndex:this.getZIndex(),update:function(){a.draw()},elementTag:"canvas"}),this.setCtx(this.canvasLayer.getContainer().getContext("2d")),this.getAnimation()&&(this.animationLayer=new CanvasLayer({map:this.getMap(),zIndex:this.getZIndex(),elementTag:"canvas"}),this.setAnimationCtx(this.animationLayer.getContainer().getContext("2d")))}},draw:function(a){var a=this.getCtx();return a?(a.clearRect(0,0,a.canvas.width,a.canvas.height),this._calculatePixel(),this._getDrawer().drawMap(),void("polyline"===this.getDataType()&&this.getAnimation()&&!this._animationFlag&&(this.drawAnimation(),this._animationFlag=!0))):!1},drawAnimation:function(){var a=this.getAnimationCtx();if(!a)return!1;a.clearRect(0,0,a.canvas.width,a.canvas.height);var b=this;this._getDrawer().drawAnimation(),this.getAnimation()&&requestAnimationFrame(function(){b.drawAnimation()})},animation_changed:function(){this.getAnimation()&&this.drawAnimation()},mapv_changed:function(){return this.getMapv()?(this.canvasLayer&&this.canvasLayer.show(),this.initialize(),this.updateControl(),void this.draw()):void(this.canvasLayer&&this.canvasLayer.hide())},drawType_changed:function(){this.updateControl(),this.draw()},drawOptions_changed:function(){this.draw()},updateControl:function(){var a=this.getMapv(),b=this._getDrawer(),c=this.getMap();b.drawDataRange?(c.addControl(a.getDataRangeCtrol()),b.drawDataRange(a.getDataRangeCtrol().getContainer())):c.removeControl(a.getDataRangeCtrol()),b.scale?(b.scale(a.Scale),a.Scale.show()):a.Scale.hide(),this.getMapv().OptionalData&&this.getMapv().OptionalData.initController(this,this.getDrawType())},_getDrawer:function(){var drawType=this.getDrawType();if(!this._drawer[drawType]){var funcName=drawType.replace(/(\w)/,function(a){return a.toUpperCase()});funcName+="Drawer";var drawer=this._drawer[drawType]=eval("(new "+funcName+"(this))");drawer.scale?(drawer.scale(this.getMapv().Scale),this.getMapv().Scale.show()):this.getMapv().Scale.hide()}return this._drawer[drawType]},_calculatePixel:function(){for(var a=this.getMapv().getMap(),b=a.getMapType().getProjection(),c=a.getZoom(),d=Math.pow(2,18-c),e=b.lngLatToPoint(a.getCenter()),f=new BMap.Pixel(e.x-a.getSize().width/2*d,e.y+a.getSize().height/2*d),g=this.getData(),a=this.getMap(),h=0;h<g.length;h++){if(g[h].lng&&g[h].lat){var i=a.pointToPixel(new BMap.Point(g[h].lng,g[h].lat));g[h].px=i.x,g[h].py=i.y}if(g[h].x&&g[h].y&&(g[h].px=(g[h].x-f.x)/d,g[h].py=(f.y-g[h].y)/d),g[h].geo){var j=[];if("bd09ll"===this.getCoordType())for(var k=0;k<g[h].geo.length;k++){var i=a.pointToPixel(new BMap.Point(g[h].geo[k][0],g[h].geo[k][1]));j.push([i.x,i.y])}else if("bd09mc"===this.getCoordType())for(var k=0;k<g[h].geo.length;k++)j.push([(g[h].geo[k][0]-f.x)/d,(f.y-g[h].geo[k][1])/d]);g[h].pgeo=j}}},data_changed:function(){var a=this.getData();if(a&&!(a.length<1)){if("polyline"===this.getDataType()&&this.getAnimation())for(var b=0;b<a.length;b++)a[b].index=parseInt(Math.random()*a[b].geo.length,10);this._min=a[0].count,this._max=a[0].count;for(var b=0;b<a.length;b++)this._max=Math.max(this._max,a[b].count),this._min=Math.min(this._min,a[b].count)}},getDataRange:function(){return{min:this._min,max:this._max}},zIndex_changed:function(a){this.canvasLayer.setZIndex(a)}}),DataControl.prototype.initDom=function(){var a=this.control=document.createElement("div"),b=this.input=document.createElement("input");b.type="file";var c=document.createElement("div");c.textContent="自定义数据：";var d=document.createElement("div");d.textContent="拖拽文件到窗口或者选择自定义文件",a.appendChild(c),a.appendChild(d),a.appendChild(b),a.style.fontSize="12px",a.style.lineHeight="1.8em",a.style.position="absolute",a.style.bottom="50px",a.style.left="10px",a.style.padding="10px 20px",a.style.color="#FFF",a.style.background="rgba(0,0,0,0.5)",a.style.zIndex="100000",a.style.overflow="hidden",a.style.webkitTransition="all 0.5s ease-in";var e=document.createElement("div"),f=document.createElement("div");f.textContent="历史数据",this.history=document.createElement("div"),e.appendChild(f),e.appendChild(this.history),a.appendChild(e),document.body.appendChild(a)},DataControl.prototype.initEvent=function(){function a(a){var c,d=!1;try{c=JSON.parse(a.replace(/\s/g,""));for(var e=0;"string"==typeof c&&10>=e;)c=JSON.parse(c),e++;d=!1}catch(f){d=!0}if(d)try{c=[];var g=a.split("\n");g.length<=1&&(g=a.split("\\n"));for(var h=g[0].split(","),i=1;i<h.length;i++){for(var j=g[i].split(","),k={},l=0,m=0;m<j.length;m++){var n=h[m]||"noname"+l++;n=n.replace(/\\r/g,""),k[n]=Number(j[m].replace(/\\r/g,"").replace(/\"/g,""))}c.push(k)}c=JSON.stringify(c).replace(/\\r/g,""),c=JSON.parse(c),d=!1}catch(f){window.console.log(f),d=!0}if(d)return alert("数据格式错误，请检查是否为json或者csv格式数据"),!1;b.geoData.setData(c),console.log(b["super"]._layers);for(var i=0;i<b["super"]._layers.length;i++)b["super"]._layers[i].draw();return!0}var b=this,c=new FileReader;c.addEventListener("load",function(d){var e=c.result,f=a(e);if(f){var g=localStorage.getItem("filenames")||"{}";if(g=JSON.parse(g),!c.fileName||!c.fileSize)return console.log("no fileName or fileSize , save faild "),!1;for(var h in g)if(g[h].name===this.fileName&&g[h].size===this.fileSize)return!1;var i=this.fileName+this.fileSize+parseInt(1e17*Math.random(),10).toString(36);g[i]={size:this.fileSize,name:this.fileName},localStorage.setItem("filenames",JSON.stringify(g)),localStorage.setItem(i,JSON.stringify(e)),b.initHistory()}}),b.history.addEventListener("click",function(b){var c=b.target;if("A"===c.nodeName){var d=c.getAttribute("storageName"),e=localStorage.getItem(d);a(e)}return!1}),b.input.addEventListener("change",function(a){c.readAsText(a.target.files[0]),c.fileName=a.target.files[0].name,c.fileSize=a.target.files[0].size}),document.addEventListener("dragover",function(a){a.preventDefault()},!1),document.addEventListener("drop",function(a){return a.preventDefault(),c.readAsText(a.dataTransfer.files[0]),c.fileName=a.dataTransfer.files[0].name,c.fileSize=a.dataTransfer.files[0].size,!1})},DataRangeControl.prototype=new BMap.Control,DataRangeControl.prototype.initialize=function(a){var b=this.canvas=document.createElement("canvas");return b.style.background="#fff",b.style.boxShadow="rgba(0,0,0,0.2) 0 0 4px 2px",b.style.border="1px solid #999999",b.style.borderRadius="4px",a.getContainer().appendChild(b),b},DataRangeControl.prototype.getContainer=function(a){return this.canvas},DrawScale.prototype.change=function(a){var b=this;b.changeFn=a},DrawScale.prototype.hide=function(){var a=this;a.box.style.display="none"},DrawScale.prototype.show=function(){var a=this;a.box.style.display="block"},DrawScale.prototype.set=function(a){var b=this;b.max=a.max||b.max,b.min=a.min||b.min,b.colors=a.colors||b.colors,b._draw()},DrawScale.prototype.init=function(){var a=this;a.changeFn=null,a.width=55,a.height=250,a.min=0,a.max=100,a.offsetTop=10,a.offsetBottom=10,a.drawHeight=a.height-a.offsetTop-a.offsetBottom,a.colors=["#49ae22","#77c01a","#a0cd12","#cadd0a","#f8ed01","#e1de03","#feb60a","#fe7e13","#fe571b","#fd3620"],a.defaultColors=["#49ae22","#77c01a","#a0cd12","#cadd0a","#f8ed01","#e1de03","#feb60a","#fe7e13","#fe571b","#fd3620"],a.point={x:0,y:0},a.hoveredHandle=null,a.showHandle=!1,a.handleStartPos={val:a.min,yMin:a.offsetTop,yMax:a.offsetTop+a.drawHeight,y:a.offsetTop},a.handleEndPos={val:a.max,yMin:a.offsetTop,yMax:a.offsetTop+a.drawHeight,y:a.offsetTop+a.drawHeight};var b=a.box=document.createElement("div"),c=document.createElement("canvas");c.width=a.width,c.height=a.height,c.style.cursor="pointer",b.style.border="1px solid #999",b.style.boxShadow="rgba(0, 0, 0, 0.2) 0px 0px 4px 2px",b.style.borderRadius="6px",b.style.background="white",b.style.position="absolute",b.style.right="10px",b.style.bottom="10px",b.style.width=a.width+"px",b.style.height=a.height+"px",b.style.zIndex=1e4,b.appendChild(c),document.body.appendChild(b),a.ctx=c.getContext("2d"),a._draw()},DrawScale.prototype._Event=function(){var a=this,b=a.ctx.canvas,c=!1,d={x:0,y:0},e={y:0,name:null};b.addEventListener("mouseenter",function(){a.showHandle=!0,a._draw()}),b.addEventListener("mouseleave",function(){a.showHandle=!1,a._draw()}),b.addEventListener("mousedown",function(b){var f=a.hoveredHandle;if(f){d.x=b.pageX,d.y=b.pageY;var g="handle"+f.name+"Pos";e.name=g,e.y=a[g].y,c=!0}}),window.addEventListener("mousemove",function(b){if(a.point.x=b.offsetX,a.point.y=b.offsetY,c){var f=b.pageY-d.y;a[e.name].y=e.y+f;var g=e.y+f,h=a[e.name].yMax,i=a[e.name].yMin;g=g>h?h:g,g=i>g?i:g,a[e.name].y=g,"handleStartPos"===e.name&&(a.handleEndPos.yMin=g),"handleEndPos"===e.name&&(a.handleStartPos.yMax=g),b.preventDefault()}a._draw()}),window.addEventListener("mouseup",function(b){c&&(a.changeFn&&a.changeFn(a.handleStartPos.val,a.handleEndPos.val),c=!1)})},DrawScale.prototype._draw=function(){var a=this,b=a.ctx;b.clearRect(0,0,b.canvas.width,b.canvas.height),a.hoveredHandle=null;var c,d=5,e=a.offsetTop,f=10,g=a.drawHeight;c="default"===a.colors?a.defaultColors:a.colors;var h=b.createLinearGradient(d,e,f,g),i=g/(c.length-1);if(a.colors instanceof Array||"default"===a.colors)for(var j=0;j<c.length;j++){var k=j*i/a.height;h.addColorStop(k,c[j])}else if("object"==typeof a.colors)for(var j in a.colors)h.addColorStop(j,a.colors[j]);b.fillStyle=b.strokeStyle=h,b.fillRect(d,e,f,g);var l=(a.handleStartPos.y-e)/g*a.max|0,m=a.handleStartPos.val=l+a.min,n=a.handleEndPos.val=(a.handleEndPos.y-e)/g*a.max|0;b.textAlign="left",b.textBaseline="middle";var o=d+f+5;b.fillText("- "+a.min,o,e),b.fillText("- "+a.max,o,e+g),b.save(),b.fillStyle="grey",a.handleStartPos.y>e+10&&b.fillText("- "+m,o,a.handleStartPos.y),a.handleEndPos.y<e+g-10&&b.fillText("- "+n,o,a.handleEndPos.y),b.restore(),a.showHandle&&(drawTips({sup:a,name:"Start",ctx:b,left:d+f,right:b.canvas.width-5,top:a.handleStartPos.y,text:m}),drawTips({sup:a,name:"End",ctx:b,left:d+f,right:b.canvas.width-5,top:a.handleEndPos.y,text:n})),b.save(),b.fillStyle="#ADABAB";var p=d,q=f;b.fillRect(p,e,q,a.handleStartPos.y-a.offsetTop),b.fillRect(p,a.handleEndPos.y,q,g-a.handleEndPos.y+a.offsetTop),b.restore(),a.hoveredHandle?b.canvas.style.cursor="pointer":b.canvas.style.cursor="default"},util.addCssByStyle(["#MapvDrawTypeControl { list-style:none; position:absolute; right:0px; top:0px; bottom:0px; padding:0; margin:0; }","#MapvDrawTypeControl li{ padding:0; margin:0; cursor:pointer; margin:1px 0;","color:#fff; padding:5px; background:rgba(0, 0, 0, 0.5); }","#MapvDrawTypeControl li.current{ background:rgba(0, 0, 255, 0.5); }"].join("\n")),util.inherits(DrawTypeControl,Class),util.inherits(DrawTypeControl,BMap.Control),DrawTypeControl.prototype.initialize=function(a){var b=this.ul=document.createElement("ul");b.setAttribute("id","MapvDrawTypeControl");var c=this;return b.addEventListener("click",function(a){var b=a.target;if("LI"===b.nodeName){for(var d=b.parentNode,e=d.getElementsByTagName("li"),f=0;f<e.length;f++)e[f].className="";var g=b.getAttribute("drawType");b.className="current",c.layer.setDrawType(g)}}),this.showLayer(),a.getContainer().appendChild(b),b},DrawTypeControl.prototype.getContainer=function(){return this.ul},DrawTypeControl.prototype.drawTypeControlOptions_changed=function(){this.layer=this.getDrawTypeControlOptions().layer,this.layer&&this.showLayer()},DrawTypeControl.prototype.showLayer=function(){if(this.layer){var a=this.ul;a.innerHTML="";for(var b=["simple","heatmap","density","bubble","category","choropleth","intensity","cluster"],c=0;c<b.length;c++){var d=b[c],e=document.createElement("li");this.layer.getDrawType()===d&&(e.className="current"),e.setAttribute("drawType",d),e.innerHTML=d,a.appendChild(e)}}},OptionalData.prototype.initCSS=function(){util.addCssByStyle([".controlBox { position:absolute; left:0px; top:0px; background:rgba(0,0,0,0.5); padding:10px; }",".controlBox input {border-radius:6px; border:none; padding:10px;}",".controlBox button ","{ padding:8px 10px; border:none; width:40%; margin-left: 10px; border-radius:6px; cursor:pointer; }",".controlBoxBlock { color:#fff; padding: 10px; }",".controlBoxTitle { display:inline-block; width:100px; text-align:right; padding-right:10px; }"].join("\n"))},OptionalData.prototype.initDom=function(){var a=this.box=document.createElement("div");a.className="controlBox";var b=this.contentBox=document.createElement("div"),c=document.createElement("div");c.style.textAlign="center";var d=this.updateBtn=document.createElement("button"),e=this.resetBtn=document.createElement("button");return d.textContent="update",e.textContent="reset",a.appendChild(b),c.appendChild(d),c.appendChild(e),a.appendChild(c),document.body.appendChild(a),a},OptionalData.prototype.initController=function(a,b){return!1},OptionalData.prototype.bindEvent=function(){var a=this;this.updateBtn.onclick=function(){for(var b=0;b<a.options.editable.length;b++){var c=a.options.editable[b].name,d=a.contentBox.querySelector('input[name="'+c+'"]');d&&("radio"===d.type?(d=a.contentBox.querySelector('input[name="'+c+'"]:checked'),a.options[c]=d.value):"checkbox"===d.type?(d=a.contentBox.querySelector('input[name="'+c+'"]'),a.options[c]=d.checked):"true"===d.getAttribute("isJson")?(console.log(1),a.options[c]=JSON.parse(d.value)):a.options[c]=d.value)}var e=a._layer._getDrawer(a.drawType);e.setDrawOptions(a.options),a._layer.draw()},this.resetBtn.onclick=function(){for(var b=0;b<a.options.editable.length;b++){var c=a.options.editable[b].name,d=a.options.editable[b]._oldVal;a.options[c]=d}var e=this._layer._getDrawer(a.drawType);e.setDrawOptions(a.options),this._layer.draw(),a.initController()}},util.inherits(Drawer,Class),Drawer.prototype.drawMap=function(){},Drawer.prototype.drawOptions_changed=function(){var a=this.getDrawOptions();a&&a.splitList?this.splitList=a.splitList:this.generalSplitList(),this.drawDataRange&&this.drawDataRange()},Drawer.prototype.colors=["rgba(17, 102, 252, 0.8)","rgba(52, 139, 251, 0.8)","rgba(110, 176, 253, 0.8)","rgba(255, 241, 193, 0.8)","rgba(255, 146, 149, 0.8)","rgba(253, 98, 104, 0.8)","rgba(255, 0, 0, 0.8)","rgba(255, 51, 61, 0.8)"],Drawer.prototype.generalSplitList=function(){var a=this.getLayer().getDataRange(),b=Math.ceil((a.max-a.min)/7),c=a.min;this.splitList=[];for(var d=1;c<a.max;)this.splitList.push({start:c,end:c+b,radius:d,color:this.colors[d-1]}),c+=b,d++},util.inherits(BubbleDrawer,Drawer),BubbleDrawer.prototype.drawMap=function(){var a=this.getLayer().getData(),b=this.getCtx();b.save();var c=this.getDrawOptions();c.globalCompositeOperation&&(b.globalCompositeOperation=c.globalCompositeOperation),b.fillStyle=c.fillStyle||"rgba(50, 50, 200, 0.8)",b.strokeStyle=c.strokeStyle,b.lineWidth=c.lineWidth||1;for(var d=0,e=a.length;e>d;d++){var f=a[d],g=this.getRadius(f.count);b.beginPath(),b.arc(f.px,f.py,g,0,2*Math.PI,!1),b.closePath(),b.fill(),c.strokeStyle&&b.stroke()}b.restore()},BubbleDrawer.prototype.getRadius=function(a){for(var b=1,c=this.splitList,d=0;d<c.length;d++)if((void 0===c[d].start||void 0!==c[d].start&&a>=c[d].start)&&(void 0===c[d].end||void 0!==c[d].end&&a<c[d].end)){b=c[d].radius;break}return b},util.inherits(CategoryDrawer,Drawer),CategoryDrawer.prototype.drawMap=function(){var a=this.getLayer().getData(),b=this.getCtx(),c=this.getDrawOptions();b.strokeStyle=c.strokeStyle;for(var d=c.radius,e=0,f=a.length;f>e;e++){var g=a[e];b.beginPath(),b.moveTo(g.px,g.py),b.fillStyle=this.getColor(g.count),b.arc(g.px,g.py,d,0,2*Math.PI),b.closePath(),b.fill()}c.strokeStyle&&b.stroke()},CategoryDrawer.prototype.generalSplitList=function(){this.splitList={other:"rgba(255, 255, 0, 0.8)",1:"rgba(253, 98, 104, 0.8)",2:"rgba(255, 146, 149, 0.8)",3:"rgba(255, 241, 193, 0.8)",4:"rgba(110, 176, 253, 0.8)",5:"rgba(52, 139, 251, 0.8)",6:"rgba(17, 102, 252)"}},CategoryDrawer.prototype.getColor=function(a){var b=this.splitList,c=b.other;for(var d in b)if(a==d){c=b[d];break}return c},util.inherits(ChoroplethDrawer,Drawer),ChoroplethDrawer.prototype.drawMap=function(){var a=this.getLayer().getData(),b=this.getCtx(),c=this.getDrawOptions();b.strokeStyle=c.strokeStyle;for(var d=0,e=a.length;e>d;d++){var f=a[d];b.fillStyle=this.getColor(f.count),b.beginPath(),b.moveTo(f.px,f.py),b.arc(f.px,f.py,c.radius,0,2*Math.PI),b.closePath(),b.fill()}c.strokeStyle&&b.stroke()},ChoroplethDrawer.prototype.getColor=function(a){for(var b=this.splitList,c="yellow",d=0;d<b.length;d++)if((void 0===b[d].start||void 0!==b[d].start&&a>=b[d].start)&&(void 0===b[d].end||void 0!==b[d].end&&a<b[d].end)){c=b[d].color;break}return c};var min,max;util.inherits(ClusterDrawer,Drawer),ClusterDrawer.prototype.drawMap=function(){window.console.time("computerMapData");var a=this.getCtx();max=min=void 0;for(var b=this.getLayer().getData(),c=this.getMapv().getMap(),d=c.getZoom(),e=this.zoomUnit=Math.pow(2,18-d),f=this.formatParam(),g=f.gridWidth,h=f.colors,i=c.getMapType().getProjection(),j=i.lngLatToPoint(c.getCenter()),k=j.x-c.getSize().width/2*e,l=new BMap.Pixel(k,j.y+c.getSize().height/2*e),m=g/e,n=parseInt(l.x/g,10)*g,o=(n-l.x)/e,p=[],q=0;o+q*m<c.getSize().width;){var r=o+q*m;p.push(r.toFixed(2)),q++}for(var s=parseInt(l.y/g,10)*g+g,t=(l.y-s)/e,u=[],v=0;t+v*m<c.getSize().height;)r=t+v*m,u.push(r.toFixed(2)),v++;for(var w={},x=0;x<p.length;x++)for(var y=0;y<u.length;y++){var z=p[x]+"_"+u[y];w[z]=0}for(var x=0;x<b.length;x++){var A=b[x].px,B=b[x].py,C=parseInt(b[x].count,10),D=A<p[0],E=B<u[0],F=A>Number(p[p.length-1])+Number(m),G=B>Number(u[u.length-1])+Number(m);if(!(D||E||F||G)){for(var y=0;y<p.length;y++){var H=Number(p[y]);if(A>=H&&H+m>A)for(var I=0;I<u.length;I++){var J=Number(u[I]);B>=J&&J+m>B&&(w[p[y]+"_"+u[I]]+=C,C=w[p[y]+"_"+u[I]])}}min=min||C,max=max||C,min=min>C?C:min,max=C>max?C:max}}var K=(max-min+1)/10;window.console.timeEnd("computerMapData"),window.console.time("drawMap");for(var x in w){var L=x.split("_");A=Number(L[0]),B=Number(L[1]);var M=(w[x]-min)/K;M=0>M?0:M;var N=(h[0|M],A+m/2),O=B+m/2;a.fillStyle="#fa8b2e",a.beginPath(),a.arc(N,O,5*M,0,2*Math.PI),a.fill(),a.lineWidth=8*M/10,a.strokeStyle="#fff",a.stroke(),a.save(),a.font=30*M/10+"px serif",a.textAlign="center",a.textBaseline="middle",0!==w[x]&&(a.fillStyle="#fff",a.fillText(w[x],N,O)),a.restore()}window.console.timeEnd("drawMap")},ClusterDrawer.prototype.formatParam=function(){var a=this.getDrawOptions(),b=this.fillColors=[[73,174,34],[119,191,26],[160,205,18],[202,221,10],[248,237,1],[225,222,3],[254,182,10],[254,126,19],[254,84,27],[253,54,32]];this.colorBar={};for(var c=0;c<b.length;c++){var d=(c+1)/b.length,e=b[c][0],f=b[c][1],g=b[c][2];this.colorBar[d]="rgb("+e+","+f+","+g+")"}var h=60;return h+=a.gridUnit||"px",h=/px$/.test(h)?parseInt(h,10)*this.zoomUnit:parseInt(h,10),{gridWidth:h,colors:b}};var min,max;util.inherits(DensityDrawer,Drawer),DensityDrawer.prototype.scale=function(a){var b=this;a.change(function(a,c){b.masker={min:a,max:c},b.ctx=b.getCtx(),b.ctx.clearRect(0,0,b.ctx.canvas.width,b.ctx.canvas.height),b.drawMap()}),this.Scale=a},DensityDrawer.prototype.drawMap=function(){var a=this,b=this.getCtx(),c=this.getLayer().getData(),d=this.getMapv().getMap(),e=d.getZoom(),f=this.zoomUnit=Math.pow(2,18-e),g=formatParam.call(this),h=g.gridWidth,i=d.getMapType().getProjection(),j=i.lngLatToPoint(d.getCenter()),k=j.x-d.getSize().width/2*f,l=new BMap.Pixel(k,j.y+d.getSize().height/2*f);window.console.time("computerMapData");var m={data:c,nwMc:l,gridWidth:h,zoomUnit:f,ctx:b},n={};n="honeycomb"===this.getDrawOptions().gridType?honeycombGrid(m):recGrids(m),console.log(n);var o=n.grids,p=n.max,q=n.min;window.console.timeEnd("computerMapData"),window.console.time("drawMap");var m={gridWidth:h,zoomUnit:f,max:p,min:q,ctx:b,grids:o,fillColors:g.colors,sup:a},n={};"honeycomb"===this.getDrawOptions().gridType?drawHoneycomb(m):drawRec(m),window.console.timeEnd("drawMap"),this.Scale&&this.Scale.set({max:p,min:q,colors:"default"})};var r=0;g=0,b=0,util.inherits(HeatmapDrawer,Drawer),HeatmapDrawer.prototype.drawMap=function(){var a=this,b=this.getCtx();this._width=b.canvas.width,this._height=b.canvas.height;var c=this.getLayer().getData();this._data=c,this.drawHeatmap(),a.Scale&&a.Scale.set({min:0,max:a.getMax(),colors:this.getGradient()})},HeatmapDrawer.prototype.scale=function(a){var b=this;a.change(function(a,c){b.masker={min:a,max:c},b.drawMap()}),b.Scale=a},util.extend(HeatmapDrawer.prototype,{defaultRadius:10,defaultGradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow","1.0":"red"},getGradient:function(){return this.getDrawOptions().gradient||this.defaultGradient},getRadius:function(){var a=this.getMap().getZoom(),b=Math.pow(2,18-a),c=this.getDrawOptions(),d=c.radius||13,e=c.unit||"px";return d="m"===e?parseInt(d,10)/b:parseInt(d,10)},getMax:function(){var a=this._max;if(void 0!==this.getDrawOptions().max)a=this.getDrawOptions().max;else{var b=this.getLayer().getDataRange();
a=b.min+.7*(b.max-b.min)}return a},data:function(a){return this._data=a,this},max:function(a){return this._max=a,this},add:function(a){return this._data.push(a),this},clear:function(){return this._data=[],this},radius:function(a,b){b=b||15;var c=this._circle=document.createElement("canvas"),d=c.getContext("2d"),e=this._r=a+b;return"rect"===this.getDrawOptions().type?c.width=c.height=e:c.width=c.height=2*e,d.shadowOffsetX=d.shadowOffsetY=200,this.getDrawOptions().blur&&(d.shadowBlur=b),d.shadowColor="black",d.beginPath(),"rect"===this.getDrawOptions().type?d.fillRect(-200,-200,c.width,c.height):d.arc(e-200,e-200,a,0,2*Math.PI,!0),d.closePath(),d.fill(),this},gradient:function(a){var b=document.createElement("canvas"),c=b.getContext("2d"),d=c.createLinearGradient(0,0,0,256);b.width=1,b.height=256;for(var e in a)d.addColorStop(e,a[e]);return c.fillStyle=d,c.fillRect(0,0,1,256),this._grad=c.getImageData(0,0,1,256).data,this},drawHeatmap:function(a){this.radius(this.getRadius()),this.gradient(this.getGradient());var b=this.getCtx();b.save(),b.clearRect(0,0,this._width,this._height);var c=this.getLayer().getDataType();if("polyline"===c){b.strokeStyle=this.getDrawOptions().strokeStyle||"rgba(0, 0, 0, 0.05)",b.lineWidth=this.getDrawOptions().lineWidth||1;for(var d=0,e=this._data.length;e>d;d++){h=this._data[d];var f=h.pgeo;b.moveTo(f[0][0],f[0][1]);for(var g=1;g<f.length;g++)b.lineTo(f[g][0],f[g][1])}b.stroke()}else for(var h,d=0,e=this._data.length;e>d;d++)h=this._data[d],h.px<0||h.py<0||h.px>b.canvas.width||h.py>b.canvas.height||(b.globalAlpha=Math.max(h.count/this.getMax(),void 0===a?.05:a),b.drawImage(this._circle,h.px-this._r,h.py-this._r));var i=b.getImageData(0,0,this._width,this._height);return this.colorize(i.data,this._grad),b.putImageData(i,0,0),b.restore(),this},colorize:function(a,b){var c=0,d=1024;this.masker.min&&(c=this.masker.min/this.getMax()*1024),this.masker.max&&(d=this.masker.max/this.getMax()*1024);for(var e,f=3,g=a.length;g>f;f+=4){e=4*a[f];var h=this.getDrawOptions().maxOpacity||.8;a[f]/256>h&&(a[f]=256*h),e&&e>=c&&d>=e?(a[f-3]=b[e],a[f-2]=b[e+1],a[f-1]=b[e+2]):a[f]=0}}}),util.inherits(IntensityDrawer,Drawer),IntensityDrawer.prototype.defaultGradient={"0.0":"yellow","1.0":"red"},IntensityDrawer.prototype.drawMap=function(){var a=this,b=this.getCtx();b.clearRect(0,0,b.canvas.width,b.canvas.height);var c=this.getLayer().getData(),d=this.getDrawOptions();b.strokeStyle=d.strokeStyle;var e=b.canvas.width,f=b.canvas.height;window.console.time("drawMap");for(var g=0,h=c.length;h>g;g++){var i=c[g];if(!(i.px<0||i.px>e||i.py<0||i.py>f)){var j=a.masker.min&&i.count<a.masker.min,k=a.masker.max&&i.count>a.masker.max;j||k||(b.beginPath(),b.moveTo(i.px,i.py),b.fillStyle=this.getColor(i.count),b.arc(i.px,i.py,d.radius||1,0,2*Math.PI),b.closePath(),b.fill())}}window.console.timeEnd("drawMap"),d.strokeStyle&&b.stroke(),this.Scale&&this.Scale.set({min:0,max:a.getMax(),colors:"default"})},IntensityDrawer.prototype.scale=function(a){var b=this;a.change(function(a,c){b.masker={min:a,max:c},b.drawMap()}),b.Scale=a},IntensityDrawer.prototype.getMax=function(){var a=this.getLayer().getDataRange(),b=a.max;return this.getDrawOptions().max&&(b=this.getDrawOptions().max),b},IntensityDrawer.prototype.getColor=function(a){var b=this.getMax(),c=a/b;c>1&&(c=1),c*=255,c=parseInt(c,10),c*=4;var d="rgba("+this._grad[c]+", "+this._grad[c+1]+", "+this._grad[c+2]+",0.8)";return d},IntensityDrawer.prototype.gradient=function(a){var b=document.createElement("canvas"),c=b.getContext("2d"),d=c.createLinearGradient(0,0,0,256);b.width=1,b.height=256;for(var e in a)d.addColorStop(e,a[e]);return c.fillStyle=d,c.fillRect(0,0,1,256),this._grad=c.getImageData(0,0,1,256).data,this},util.inherits(SimpleDrawer,Drawer),SimpleDrawer.prototype.drawMap=function(){var a=this.getLayer().getData(),b=this.getCtx(),c=this.getDrawOptions();console.log("????",c),b.fillStyle=c.fillStyle||"rgba(50, 50, 200, 0.8)",b.strokeStyle=c.strokeStyle,b.lineWidth=c.lineWidth||1,c.shadowColor&&(b.shadowColor=c.shadowColor||"black"),c.shadowBlur&&(b.shadowBlur=c.shadowBlur),b.beginPath(),c.globalCompositeOperation&&(b.globalCompositeOperation=c.globalCompositeOperation);var d=Math.pow(2,18-this.getMap().getZoom()),e=c.radius||3,f=c.unit||"px";e="m"===f?parseInt(e,10)/d:parseInt(e,10);var g=this.getLayer().getDataType();if("polyline"===g||"polygon"===g){for(var h=0,i=a.length;i>h;h++){var j=a[h].pgeo;b.moveTo(j[0][0],j[0][1]);for(var k=1;k<j.length;k++)b.lineTo(j[k][0],j[k][1])}"polygon"===g&&(b.closePath(),b.fill()),(c.strokeStyle||"polyline"===g)&&b.stroke()}else{for(var h=0,i=a.length;i>h;h++){var l=a[h];l.px<0||l.px>b.canvas.width||l.py<0||l>b.canvas.height||(b.moveTo(l.px,l.py),b.arc(l.px,l.py,e,0,2*Math.PI,!1))}b.fill(),c.strokeStyle&&b.stroke()}},SimpleDrawer.prototype.drawAnimation=function(){var a=this.getLayer().getData(),b=this.getLayer().getDataType(),c=this.getLayer().getAnimationOptions(),d=this.getLayer().getAnimationCtx();if("polyline"===b)for(var e=0,f=a.length;f>e;e++){var g=a[e].index,h=a[e].pgeo,i=h[g][0],j=h[g][1],k=d.createRadialGradient(i,j,0,i,j,c.radius);k.addColorStop(0,"rgba(255, 255, 255, 1)"),k.addColorStop(.4,"rgba(255, 255, 255, 0.9)"),k.addColorStop(1,"rgba(255, 255, 255, 0)"),d.fillStyle=k,d.beginPath(),d.arc(i,j,c.radius,0,2*Math.PI,!1),d.closePath(),d.fill(),a[e].index++,a[e].index>=a[e].pgeo.length&&(a[e].index=0)}},Mapv.Layer=Layer,this.Mapv=Mapv}();