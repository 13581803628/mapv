<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title></title>

    <style type="text/css">
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkOU6Ut2S2p90EyNlOx8HGaivgC8YD47s"></script>
    <script type="text/javascript" src="https://brendankenny.github.io/CanvasLayer/src/CanvasLayer.js"></script>
    <script type="text/javascript" src="../build/mapv.js"></script>

    <script type="text/javascript">

        // Create a map object and specify the DOM element for display.
        var map = new google.maps.Map(document.getElementById('map'), {
            center: new google.maps.LatLng(39.3, -95.8),
            scrollwheel: false,
            zoom: 4
        });

        var resolutionScale = window.devicePixelRatio || 1;

        var randomCount = 1000;
        var data = [];
        while (randomCount--) {
            data.push({
                lng: -125.8 + Math.random() * 50,
                lat: 30.3 + Math.random() * 20,
                size: 1 * Math.random(),
            });
        }

        // initialize the canvasLayer
        var canvasLayerOptions = {
            map: map,
            animate: false,
            updateHandler: update,
            resolutionScale: resolutionScale
        };

        var canvasLayer = new CanvasLayer(canvasLayerOptions);
        var context = canvasLayer.canvas.getContext('2d');

        function update() {
            // clear previous canvas contents
            var canvasWidth = canvasLayer.canvas.width;
            var canvasHeight = canvasLayer.canvas.height;
            context.clearRect(0, 0, canvasWidth, canvasHeight);

            // we like our rectangles hideous
            context.fillStyle = 'rgba(230, 77, 26, 1)';
            
            /* We need to scale and translate the map for current view.
             * see https://developers.google.com/maps/documentation/javascript/maptypes#MapCoordinates
             */
            var mapProjection = map.getProjection();

            /**
             * Clear transformation from last update by setting to identity matrix.
             * Could use context.resetTransform(), but most browsers don't support
             * it yet.
             */
            context.setTransform(1, 0, 0, 1, 0, 0);
            
            // scale is just 2^zoom
            // If canvasLayer is scaled (with resolutionScale), we need to scale by
            // the same amount to account for the larger canvas.
            var scale = Math.pow(2, map.zoom) * resolutionScale;
            context.scale(scale, scale);

            /* If the map was not translated, the topLeft corner would be 0,0 in
             * world coordinates. Our translation is just the vector from the
             * world coordinate of the topLeft corder to 0,0.
             */
            var offset = mapProjection.fromLatLngToPoint(canvasLayer.getTopLeft());
            context.translate(-offset.x, -offset.y);

            var options = {
                fillStyle: 'rgba(255, 50, 50, 0.5)',
                draw: 'simple'
            }

            for (var i = 0; i < data.length; i++) {
                var latLng = new google.maps.LatLng(data[i].lat, data[i].lng);
                var worldPoint = mapProjection.fromLatLngToPoint(latLng);
                data[i].x = worldPoint.x;
                data[i].y = worldPoint.y;
            }

            mapv.canvasPoint.draw(context, data, options);
        }

    </script>
	
</body>
</html>
